trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - feature/*

pool:
  name: Default 

variables:
  PYTHON_VERSION: '3.11'

stages:
- stage: BuildAndTest
  displayName: "Compilar y Probar"
  jobs:
  - job: TestPython
    displayName: "Pruebas en Python 3.11"
    steps:
    - script: |
        # Verificar Python disponible
        echo "Python versions available:"
        python3 --version || true
        python --version || true
        which python3
        which python
      displayName: 'Verificar entorno Python'
    
    - script: |
        # Usar python3 expl√≠citamente (Mac)
        python3 -m pip install --upgrade pip
        python3 -m pip install -r requirements.txt
        python3 -m pip install coverage pytest pytest-azurepipelines pylint bandit
      displayName: 'Instalar dependencias'
    
    - script: |
        # Crear directorio para resultados
        mkdir -p test-results
      displayName: 'Preparar directorios'
    
    # Ejecutar pruebas unitarias tradicionales
    - script: |
        python3 -m unittest discover -v
      displayName: 'Ejecutar pruebas unitarias (unittest)'
    
    # Ejecutar pruebas con pytest
    - script: |
        python3 -m pytest \
          test_core_bancario.py \
          --maxfail=5 \
          --disable-warnings \
          --junitxml=test-results/junit.xml \
          -v
      displayName: 'Ejecutar pruebas con pytest'
    
    # Ejecutar con cobertura
    - script: |
        python3 -m pytest \
          test_core_bancario.py \
          --cov=core_bancario \
          --cov-report=xml:coverage.xml \
          --cov-report=html:htmlcov
      displayName: 'Ejecutar pruebas con cobertura'
    
    # Publicar resultados de pruebas
    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '**/test-results/*.xml'
        testRunTitle: 'Pruebas Python 3.11'
      displayName: 'Publicar resultados de pruebas'
      condition: succeededOrFailed()
    
    # Publicar reporte de cobertura
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'cobertura'
        summaryFileLocation: 'coverage.xml'
        reportDirectory: 'htmlcov'
      displayName: 'Publicar reporte de cobertura'
    
    # An√°lisis est√°tico
    - script: |
        echo "=== An√°lisis Pylint ==="
        python3 -m pylint core_bancario.py test_core_bancario.py --exit-zero || true
        echo ""
        echo "=== An√°lisis Bandit (seguridad) ==="
        python3 -m bandit -r . -f json -o bandit-report.json || true
      displayName: 'An√°lisis de calidad'
    
    # Estad√≠sticas del proyecto
    - script: |
        echo "=== Estad√≠sticas del Proyecto ==="
        echo ""
        echo "üìä L√≠neas de c√≥digo:"
        wc -l core_bancario.py
        echo ""
        echo "üß™ L√≠neas de pruebas:"
        wc -l test_core_bancario.py
        echo ""
        echo "‚úÖ Cantidad total de pruebas:"
        python3 -m pytest test_core_bancario.py --collect-only | grep "test_" | wc -l
        echo ""
        echo "üêç Versi√≥n Python:"
        python3 --version
      displayName: 'Generar estad√≠sticas'
    
    # Guardar artefactos
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: 'htmlcov'
        artifactName: 'CodeCoverageReport'
      displayName: 'Guardar reporte de cobertura HTML'
    
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.SourcesDirectory)'
        artifactName: 'SourceCode'
      displayName: 'Guardar c√≥digo fuente'