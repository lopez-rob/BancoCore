trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main

pool:
  name: Default  # Tu agente Mac

variables:
  PYTHON_VERSION: '3.11'

stages:
- stage: BuildAndTest
  displayName: "Compilar y Probar"
  jobs:
  - job: TestPython
    displayName: "Pruebas Python 3.11"
    steps:
    - script: |
        # Verificar Python en Mac - USAR SOLO python3
        echo "=== Entorno Mac ==="
        echo "Python3 version:"
        python3 --version
        echo ""
        echo "Python3 ubicaciÃ³n:"
        which python3
        echo ""
        echo "=== Directorio actual ==="
        pwd
        ls -la
      displayName: 'Verificar entorno Mac'
    
    - script: |
        # Instalar dependencias con python3
        echo "Instalando dependencias..."
        python3 -m pip install --upgrade pip
        python3 -m pip install -r requirements.txt
        python3 -m pip install coverage pytest pytest-azurepipelines
      displayName: 'Instalar dependencias'
    
    - script: |
        # Crear directorios necesarios
        mkdir -p test-results
        mkdir -p htmlcov
      displayName: 'Preparar directorios'
    
    # Ejecutar pruebas unitarias
    - script: |
        echo "=== Ejecutando pruebas unitarias ==="
        python3 -m unittest test_core_bancario.TestCoreBancario -v
      displayName: 'Pruebas Unitarias'
    
    # Ejecutar pruebas avanzadas
    - script: |
        echo "=== Ejecutando pruebas avanzadas ==="
        python3 -m unittest test_core_bancario.TestCoreBancarioAvanzado -v
      displayName: 'Pruebas Avanzadas'
    
    # Ejecutar TODAS las pruebas
    - script: |
        echo "=== Ejecutando TODAS las pruebas ==="
        python3 -m unittest discover -v
      displayName: 'Todas las pruebas'
    
    # Ejecutar con pytest
    - script: |
        echo "=== Ejecutando con pytest ==="
        python3 -m pytest test_core_bancario.py \
          --maxfail=5 \
          --disable-warnings \
          --junitxml=test-results/junit.xml \
          -v
      displayName: 'Pruebas con pytest'
    
    # Cobertura de cÃ³digo
    - script: |
        echo "=== Calculando cobertura ==="
        python3 -m pytest test_core_bancario.py \
          --cov=core_bancario \
          --cov-report=xml:coverage.xml \
          --cov-report=html:htmlcov \
          --cov-report=term
      displayName: 'Cobertura de cÃ³digo'
    
    # Publicar resultados
    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '**/test-results/*.xml'
        testRunTitle: 'Pruebas Bancario Core'
      displayName: 'Publicar resultados'
      condition: succeededOrFailed()
    
    # Publicar cobertura
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'cobertura'
        summaryFileLocation: 'coverage.xml'
        reportDirectory: 'htmlcov'
      displayName: 'Publicar cobertura'
    
    # EstadÃ­sticas
    - script: |
        echo "=== ðŸ“Š ESTADÃSTICAS FINALES ==="
        echo ""
        echo "ðŸ§¾ Archivos del proyecto:"
        ls -la
        echo ""
        echo "ðŸ“„ LÃ­neas de cÃ³digo (core_bancario.py):"
        wc -l core_bancario.py
        echo ""
        echo "ðŸ§ª LÃ­neas de pruebas (test_core_bancario.py):"
        wc -l test_core_bancario.py
        echo ""
        echo "âœ… Pruebas encontradas:"
        python3 -m pytest test_core_bancario.py --collect-only 2>/dev/null | grep "test_" | wc -l
        echo ""
        echo "ðŸŽ¯ Resumen ejecuciÃ³n:"
        echo "Python: $(python3 --version)"
        echo "Pipeline ejecutado en: $(date)"
      displayName: 'Generar estadÃ­sticas'
    
    # Guardar artefactos
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: 'htmlcov'
        artifactName: 'CoberturaHTML'
      displayName: 'Guardar cobertura HTML'