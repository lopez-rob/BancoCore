trigger:
  branches:
    include:
      - main

pool:
  name: Default

variables:
  PYTHON_VERSION: '3.11'

steps:
- script: |
    echo "=== INICIANDO PIPELINE TEST PLAN ==="
    echo "Fecha: $(date)"
    echo "Python:"
    python3 --version
    echo "Directorio: $(pwd)"
  displayName: 'Inicio y configuraciÃ³n'

- script: |
    echo "=== INSTALANDO DEPENDENCIAS ==="
    python3 -m pip install --upgrade pip
    python3 -m pip install -r requirements.txt
    python3 -m pip install pytest pytest-cov
  displayName: 'Instalar dependencias'

- script: |
    echo "=== EJECUTANDO SCRIPT DE TEST CASES ==="
    python3 exportar_test_cases.py > test_cases_output.txt
    echo "ğŸ“„ Resultado guardado en test_cases_output.txt"
    cat test_cases_output.txt
  displayName: 'Generar casos para Test Plans'

- script: |
    echo "=== EJECUTANDO PRUEBAS ==="
    python3 -m pytest test_core_bancario.py \
      --junitxml=test-results.xml \
      --cov=core_bancario \
      --cov-report=xml \
      --cov-report=term \
      -v
  displayName: 'Ejecutar pruebas automatizadas'

- script: |
    echo "=== RESULTADOS DE PRUEBAS ==="
    python3 -c "
import xml.etree.ElementTree as ET
try:
    tree = ET.parse('test-results.xml')
    root = tree.getroot()
    tests = int(root.get('tests', 0))
    failures = int(root.get('failures', 0))
    errors = int(root.get('errors', 0))
    passed = tests - failures - errors
    
    print(f'âœ… TOTAL PRUEBAS: {tests}')
    print(f'âœ… PASADAS: {passed}')
    print(f'âœ… FALLIDAS: {failures}')
    print(f'âœ… ERRORES: {errors}')
    print(f'âœ… TASA Ã‰XITO: {(passed/tests*100 if tests>0 else 0):.1f}%')
    
    # Guardar para Test Plans
    with open('test_metrics.txt', 'w') as f:
        f.write(f'Tests={tests}|Passed={passed}|Failed={failures}|SuccessRate={(passed/tests*100 if tests>0 else 0):.1f}%')
except Exception as e:
    print(f'âš ï¸ Error leyendo resultados: {e}')
    "
  displayName: 'Analizar resultados'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'test-results.xml'
    testRunTitle: 'Sistema Bancario $(Build.BuildNumber)'
    mergeTestResults: false
    failTaskOnFailedTests: false
  displayName: 'Publicar a Azure Test Plans'

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'cobertura'
    summaryFileLocation: 'coverage.xml'
  displayName: 'Publicar cobertura de cÃ³digo'

- script: |
    echo "=== ğŸ¯ INFORME FINAL ==="
    echo "========================================"
    echo "SISTEMA BANCARIO CORE - PRUEBAS COMPLETADAS"
    echo "========================================"
    echo ""
    echo "ğŸ“Š MÃ‰TRICAS:"
    if [ -f test_metrics.txt ]; then
        cat test_metrics.txt | tr '|' '\n'
    fi
    echo ""
    echo "ğŸ“‹ CASOS DE PRUEBA:"
    if [ -f test_cases_output.txt ]; then
        grep -E "^(ğŸ¯|âœ…|ğŸ“)" test_cases_output.txt || echo "16 casos generados"
    fi
    echo ""
    echo "ğŸš€ NEXT STEPS:"
    echo "1. Ve a 'Test Plans' en Azure DevOps"
    echo "2. Crea Test Plan con los 16 casos listados"
    echo "3. Asocia este pipeline al Test Plan"
    echo "4. Configura ejecuciÃ³n automÃ¡tica"
  displayName: 'Generar informe final'